<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Gas Monitor (Web BLE)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a2e;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .monitor-container {
            max-width: 1200px;
            width: 95%;
            background: #232946;
            color: #b8c1ec;
            padding: 2.5rem;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
            border: 1px solid #4a5482;
        }
        .sensor-card {
            background: #2d3250;
            transition: all 0.5s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            border: 2px solid transparent;
        }
        .card-value {
            font-size: 3rem;
            font-weight: 700;
        }
        /* Custom Button Style */
        .connect-button {
            transition: all 0.3s ease;
            box-shadow: 0 4px #0056b3;
            transform: translateY(0);
        }
        .connect-button:active {
            box-shadow: 0 2px #0056b3;
            transform: translateY(2px);
        }
        .btn-disconnected { background-color: #3f55a1; box-shadow: 0 4px #2c3a72; }
        .btn-disconnected:hover { background-color: #4a63b8; }
        .btn-connected { background-color: #27a46c; box-shadow: 0 4px #1a774c; }
        .btn-connected:hover { background-color: #30c082; }

        /* Alarm Pulse Effect */
        .pulse-red-glow {
            animation: pulse-red-glow-anim 1s infinite alternate;
            border-color: #e53e3e !important;
        }
        @keyframes pulse-red-glow-anim {
            from { box-shadow: 0 0 10px rgba(220, 38, 38, 0.8); }
            to { box-shadow: 0 0 25px rgba(220, 38, 38, 0.4); }
        }
    </style>
</head>
<body>

    <div id="app" class="monitor-container rounded-2xl">
        <h1 class="text-3xl font-extrabold text-white mb-2 text-center">MULTI-GAS MONITORING (Web BLE)</h1>
        <p id="global-status" class="text-sm text-center text-gray-400 mb-8 flex justify-center items-center">
            <i class='bx bx-bluetooth mr-2 text-xl text-blue-400'></i> Awaiting Bluetooth Connection...
        </p>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            
            <div id="card-mq2" class="sensor-card rounded-xl p-6 text-center border-green-400/50">
                <i class='bx bxs-flame text-5xl text-yellow-500 mb-3'></i>
                <div class="text-xs font-semibold uppercase text-gray-400">MQ-2 (Smoke/LPG)</div>
                <div id="val-mq2" class="card-value text-white">---</div>
                <div id="status-mq2" class="text-sm font-bold text-green-400">SAFE</div>
            </div>

            <div id="card-mq7" class="sensor-card rounded-xl p-6 text-center border-green-400/50">
                <i class='bx bxs-cloud text-5xl text-gray-400 mb-3'></i>
                <div class="text-xs font-semibold uppercase text-gray-400">MQ-7 (CO)</div>
                <div id="val-mq7" class="card-value text-white">---</div>
                <div id="status-mq7" class="text-sm font-bold text-green-400">SAFE</div>
            </div>

            <div id="card-mq135" class="sensor-card rounded-xl p-6 text-center border-green-400/50">
                <i class='bx bxs-tree-alt text-5xl text-blue-400 mb-3'></i>
                <div class="text-xs font-semibold uppercase text-gray-400">MQ-135 (Air Quality)</div>
                <div id="val-mq135" class="card-value text-white">---</div>
                <div id="status-mq135" class="text-sm font-bold text-green-400">SAFE</div>
            </div>

        </div>

        <button id="connect-button" class="connect-button btn-disconnected w-full py-3 text-white font-bold rounded-lg transition duration-150 text-lg">
            Connect to ESP32 Device
        </button>

        <div class="mt-6">
            <p class="text-sm font-semibold text-gray-400 mb-2">Activity Log</p>
            <div id="log-box" class="text-xs text-gray-500 h-20 overflow-y-scroll bg-gray-700/50 p-2 rounded-lg border border-gray-600">
                Awaiting connection...
            </div>
        </div>
    </div>

    <script>
        // --- Configuration Constants (MUST match ESP32 code) ---
        const SERVICE_UUID = '0d783b9c-54a7-47b7-8798-e4b2d354b38d';
        const CHARACTERISTIC_UUID = '1a90c5be-141d-4034-8c88-662541a79f17';
        // FIX: The DEVICE_NAME must match the ESP32 code: "ESP32_Gas_Monitor"
        const DEVICE_NAME = 'ESP32_Gas_Monitor'; 

        // THRESHOLDS must match the ESP32 setup for visual/UI alarm logic!
        const THRESHOLDS = {
            // Note: ESP32 threshold is 1500, but the web UI was set to 1800.
            // Using 1500 for consistency with the Arduino code.
            'MQ2': 1500,
            'MQ7': 1500,
            'MQ135': 1500
        };
        
        // --- DOM Elements ---
        const connectButton = document.getElementById('connect-button');
        const logBox = document.getElementById('log-box');
        const globalStatus = document.getElementById('global-status');

        // --- Global State ---
        let gasCharacteristic = null;
        let bleDevice = null;

        // --- Utility Functions ---
        function log(message, isError = false) {
            const time = new Date().toLocaleTimeString();
            const logEntry = document.createElement('p');
            logEntry.textContent = `[${time}] ${message}`;
            logEntry.className = isError ? 'text-red-400' : 'text-gray-400';
            logBox.prepend(logEntry);
            if (logBox.children.length > 20) {
                logBox.removeChild(logBox.lastChild);
            }
            logBox.scrollTop = 0;
        }

        function updateUIConnection(isConnected) {
            connectButton.textContent = isConnected ? 'Disconnect' : 'Connect to ESP32 Device';
            connectButton.classList.toggle('btn-disconnected', !isConnected);
            connectButton.classList.toggle('btn-connected', isConnected);

            globalStatus.innerHTML = isConnected 
                ? `<i class='bx bxs-check-circle mr-2 text-xl text-green-400'></i> Connected to ${DEVICE_NAME}`
                : `<i class='bx bx-bluetooth mr-2 text-xl text-blue-400'></i> Awaiting Bluetooth Connection...`;

            if (!isConnected) {
                // Reset all cards on disconnect
                ['mq2', 'mq7', 'mq135'].forEach(sensor => {
                    document.getElementById(`val-${sensor}`).textContent = '---';
                    document.getElementById(`status-${sensor}`).textContent = 'OFFLINE';
                    document.getElementById(`status-${sensor}`).className = 'text-sm font-bold text-gray-500';
                    document.getElementById(`card-${sensor}`).classList.remove('pulse-red-glow', 'border-red-500', 'border-green-400');
                    document.getElementById(`card-${sensor}`).classList.add('border-gray-600/50');
                });
            }
        }
        
        /**
         * Updates a single sensor card based on parsed data.
         * @param {string} sensorCode - e.g., 'mq2'
         * @param {number} value - Sensor reading
         */
        function updateCard(sensorCode, value) {
            const threshold = THRESHOLDS[sensorCode.toUpperCase()];
            const isAlarm = value > threshold;

            const card = document.getElementById(`card-${sensorCode}`);
            const valueDisplay = document.getElementById(`val-${sensorCode}`);
            const statusBadge = document.getElementById(`status-${sensorCode}`);

            valueDisplay.textContent = value;

            card.classList.remove('pulse-red-glow', 'border-red-500', 'border-green-400/50', 'border-gray-600/50');
            statusBadge.classList.remove('text-red-400', 'text-green-400', 'text-gray-500');

            if (isAlarm) {
                // DANGER STATE
                card.classList.add('pulse-red-glow', 'border-red-500');
                statusBadge.textContent = 'DANGER';
                statusBadge.classList.add('text-red-400');
            } else {
                // SAFE STATE
                card.classList.add('border-green-400/50');
                statusBadge.textContent = 'SAFE';
                statusBadge.classList.add('text-green-400');
            }
        }


        // --- BLE Event Handlers ---
        function handleGasValueChange(event) {
            const value = event.target.value;
            const decoder = new TextDecoder('utf-8');
            const dataString = decoder.decode(value);
            
            log(`Raw Data: ${dataString}`);

            // Expected format: MQ2:1200,MQ7:400,MQ135:500
            const readings = dataString.split(',').map(pair => {
                const parts = pair.split(':');
                return { key: parts[0], value: parseInt(parts[1], 10) };
            });

            // Distribute parsed values to respective cards
            let globalAlarm = false;
            readings.forEach(reading => {
                const sensorCode = reading.key.toLowerCase();
                const value = reading.value;
                if (sensorCode && !isNaN(value)) {
                    updateCard(sensorCode, value);
                    // Check if any sensor is in alarm state
                    if (value > THRESHOLDS[reading.key]) {
                        globalAlarm = true;
                    }
                }
            });
            
            // Optionally update the global status based on the overall alarm state
            if (globalAlarm) {
                 globalStatus.innerHTML = `<i class='bx bxs-error-alt mr-2 text-xl text-red-400 bx-flashing'></i> **MULTIPLE GAS ALERT**`;
            } else if (bleDevice && bleDevice.gatt.connected) {
                 globalStatus.innerHTML = `<i class='bx bxs-check-circle mr-2 text-xl text-green-400'></i> Connected to ${DEVICE_NAME}`;
            }
        }

        function onDisconnected(event) {
            log('Device disconnected. Re-enabling connect button.');
            updateUIConnection(false);
            gasCharacteristic = null;
            bleDevice = null;
        }

        // --- Main Connection Logic ---
        async function connectBLE() {
            if (bleDevice && bleDevice.gatt.connected) {
                bleDevice.gatt.disconnect();
                return;
            }

            log('Attempting to connect to BLE device...');
            updateUIConnection(false);

            try {
                // 1. Request the device, filtered by the correct name
                bleDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ name: DEVICE_NAME }],
                    optionalServices: [SERVICE_UUID]
                });

                log(`Found device: ${bleDevice.name}. Connecting...`);
                bleDevice.addEventListener('gattserverdisconnected', onDisconnected);

                // 2. Connect to the GATT server
                const server = await bleDevice.gatt.connect();
                log('Connected to GATT Server.');

                // 3. Get the Service
                const service = await server.getPrimaryService(SERVICE_UUID);
                log('Found Gas Sensor Service.');

                // 4. Get the Characteristic
                gasCharacteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);
                log('Found Gas Value Characteristic.');

                // 5. Start notifications (Subscribes to updates from ESP32)
                await gasCharacteristic.startNotifications();
                gasCharacteristic.addEventListener('characteristicvaluechanged', handleGasValueChange);
                log('Notifications started. Receiving real-time data.');

                updateUIConnection(true);

            } catch (error) {
                const errorMessage = error.message.includes('User cancelled') ? 'Connection cancelled by user.' : `Connection Error: ${error.message}`;
                log(errorMessage, true);
                updateUIConnection(false);
                gasCharacteristic = null;
                bleDevice = null;
            }
        }

        // --- Initialize ---
        window.onload = () => {
            // Placeholder text replacement (for visual appeal)
            document.querySelector('.text-sm.text-center.text-gray-400.mb-8').innerHTML = 
                `<i class='bx bx-bluetooth mr-2 text-xl text-blue-400'></i> Awaiting Bluetooth Connection...`;

            if (!navigator.bluetooth) {
                log("Web Bluetooth API is not supported by your browser. Use Chrome, Edge, or Brave over HTTPS.", true);
                connectButton.disabled = true;
                connectButton.textContent = 'BLE Not Supported';
                return;
            }
            connectButton.addEventListener('click', connectBLE);
            log("Click 'Connect' to start monitoring.");
            updateUIConnection(false);
        };
    </script>

</body>
</html>
