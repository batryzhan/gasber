<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MQ-2 Gas Monitor (Web BLE)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Boxicons (bxs- for solid icons) -->
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a2e; /* Dark background for modern look */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .monitor-card {
            max-width: 520px;
            width: 95%;
            background: #232946; /* Slightly lighter dark card */
            color: #b8c1ec;
            padding: 2.5rem;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
            border: 1px solid #4a5482;
        }
        /* Custom Button Style (uiverse.io-inspired glow/lift) */
        .connect-button {
            transition: all 0.3s ease;
            box-shadow: 0 4px #0056b3; /* Default shadow */
            transform: translateY(0);
        }
        .connect-button:active {
            box-shadow: 0 2px #0056b3;
            transform: translateY(2px);
        }
        .btn-disconnected {
            background-color: #3f55a1;
            box-shadow: 0 4px #2c3a72;
        }
        .btn-disconnected:hover {
            background-color: #4a63b8;
        }
        .btn-connected {
            background-color: #27a46c;
            box-shadow: 0 4px #1a774c;
        }
        .btn-connected:hover {
            background-color: #30c082;
        }

        /* Alarm Pulse Effect */
        .pulse-red-glow {
            animation: pulse-red-glow-anim 1s infinite cubic-bezier(0.5, 0, 0.5, 1);
            border-color: #e53e3e !important;
        }
        @keyframes pulse-red-glow-anim {
            0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(220, 38, 38, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
        }

        .status-box {
            min-height: 150px;
        }
        .gas-reading {
            letter-spacing: 0.1em;
        }
    </style>
</head>
<body>

    <div id="app" class="monitor-card rounded-2xl">
        <h1 class="text-3xl font-extrabold text-white mb-2 text-center">GAS LEAK MONITOR</h1>
        <p class="text-sm text-center text-gray-400 mb-8">ESP32 & MQ-2 Sensor via Web BLE</p>
        
        <!-- Status Indicator / Reading Area -->
        <div id="status-display" class="status-box p-8 text-center rounded-xl mb-8 transition-all duration-500 bg-gray-700/30 border-4 border-transparent flex flex-col justify-center items-center">
            
            <i id="status-icon" class='bx bx-bluetooth text-5xl text-blue-400 mb-3 transition-colors'></i>
            
            <p id="gas-value" class="text-5xl font-extrabold text-white gas-reading">---</p>
            <p class="text-xs font-semibold uppercase mt-1 text-gray-400">Raw Sensor Reading</p>

            <div class="mt-4">
                <p id="status-message" class="text-xl font-bold text-blue-400">Awaiting Connection...</p>
            </div>
        </div>

        <!-- Connection Details -->
        <div class="bg-gray-700/50 p-4 rounded-lg mb-6 text-sm">
            <div class="flex justify-between items-center py-1 border-b border-gray-600">
                <span class="font-medium text-gray-400 flex items-center"><i class='bx bxs-server mr-2 text-lg'></i>Device Name:</span>
                <span class="font-semibold text-white">{{ DEVICE_NAME }}</span>
            </div>
            <div class="flex justify-between items-center py-1">
                <span class="font-medium text-gray-400 flex items-center"><i class='bx bxs-bell-ring mr-2 text-lg'></i>Alarm Threshold:</span>
                <span class="font-bold text-red-400">{{ GAS_THRESHOLD }} (ADC)</span>
            </div>
        </div>

        <!-- Connection Button -->
        <button id="connect-button" class="connect-button btn-disconnected w-full py-3 text-white font-bold rounded-lg transition duration-150 text-lg">
            Connect to ESP32 Device
        </button>

        <!-- Debug Log -->
        <div class="mt-6">
            <p class="text-sm font-semibold text-gray-400 mb-2">Activity Log</p>
            <div id="log-box" class="text-xs text-gray-500 h-20 overflow-y-scroll bg-gray-700/50 p-2 rounded-lg border border-gray-600">
                Awaiting connection...
            </div>
        </div>
    </div>

    <script>
        // --- Configuration Constants (Must match ESP32 code) ---
        const SERVICE_UUID = '0d783b9c-54a7-47b7-8798-e4b2d354b38d';
        const CHARACTERISTIC_UUID = '1a90c5be-141d-4034-8c88-662541a79f17';
        const GAS_THRESHOLD = 1000;
        const DEVICE_NAME = 'MQ2_Gas_Sensor'; 
        
        // --- DOM Elements ---
        const appDiv = document.getElementById('app');
        const connectButton = document.getElementById('connect-button');
        const statusDisplay = document.getElementById('status-display');
        const statusMessage = document.getElementById('status-message');
        const statusIcon = document.getElementById('status-icon');
        const gasValueDisplay = document.getElementById('gas-value');
        const logBox = document.getElementById('log-box');

        // --- Global State ---
        let gasCharacteristic = null;
        let bleDevice = null;

        // --- Utility Functions ---
        function log(message, isError = false) {
            const time = new Date().toLocaleTimeString();
            const logEntry = document.createElement('p');
            logEntry.textContent = `[${time}] ${message}`;
            logEntry.className = isError ? 'text-red-400' : 'text-gray-400';
            logBox.prepend(logEntry);
            if (logBox.children.length > 20) {
                logBox.removeChild(logBox.lastChild);
            }
            // Auto-scroll to top for newest logs
            logBox.scrollTop = 0;
        }

        function updateUI(isConnected, gasValue = '---', isAlarm = false) {
            // Update button state and color
            connectButton.textContent = isConnected ? 'Disconnect' : 'Connect to ESP32 Device';
            connectButton.classList.toggle('btn-disconnected', !isConnected);
            connectButton.classList.toggle('btn-connected', isConnected);

            // Update main status display
            gasValueDisplay.textContent = gasValue;

            if (isConnected) {
                // Clear initial status and reading display
                statusDisplay.classList.remove('bg-gray-700/30');

                if (isAlarm) {
                    // ALARM STATE: Red, prominent glow, bell icon
                    statusDisplay.classList.add('pulse-red-glow');
                    statusDisplay.classList.remove('border-green-400');
                    statusDisplay.classList.add('border-red-500', 'bg-red-900/40');
                    statusMessage.textContent = 'GAS LEAK DETECTED!';
                    statusMessage.classList.remove('text-green-400');
                    statusMessage.classList.add('text-red-400');
                    
                    statusIcon.className = 'bx bxs-bell-ring text-red-400 text-6xl mb-3 transition-colors bx-tada'; // Boxicon bell ring with animation
                    gasValueDisplay.classList.add('text-red-300');

                } else {
                    // SAFE STATE: Green, solid border, shield icon
                    statusDisplay.classList.remove('pulse-red-glow', 'border-red-500', 'bg-red-900/40');
                    statusDisplay.classList.add('border-green-400', 'bg-green-900/40');
                    statusMessage.textContent = 'All Clear (Safe)';
                    statusMessage.classList.remove('text-red-400');
                    statusMessage.classList.add('text-green-400');

                    statusIcon.className = 'bx bxs-shield-check text-green-400 text-6xl mb-3 transition-colors'; // Boxicon shield check
                    gasValueDisplay.classList.remove('text-red-300');
                    gasValueDisplay.classList.add('text-white');
                }
            } else {
                // DISCONNECTED STATE: Default blue/gray
                statusDisplay.classList.remove('pulse-red-glow', 'border-red-500', 'border-green-400', 'bg-red-900/40', 'bg-green-900/40');
                statusDisplay.classList.add('bg-gray-700/30', 'border-transparent');
                statusMessage.textContent = 'Awaiting Connection...';
                statusMessage.classList.remove('text-red-400', 'text-green-400');
                statusMessage.classList.add('text-blue-400');
                
                statusIcon.className = 'bx bx-bluetooth text-blue-400 text-5xl mb-3 transition-colors'; // Boxicon bluetooth symbol
                gasValueDisplay.classList.remove('text-red-300');
                gasValueDisplay.classList.add('text-white');
            }
        }

        // --- BLE Event Handlers ---
        function handleGasValueChange(event) {
            // Data received from ESP32 is a DataView. We convert it to a string.
            const value = event.target.value;
            const decoder = new TextDecoder('utf-8');
            const dataString = decoder.decode(value);
            
            const gasValue = parseInt(dataString, 10);
            const isAlarm = gasValue > GAS_THRESHOLD;

            log(`Data received: ${gasValue} (Alarm: ${isAlarm ? 'TRUE' : 'FALSE'})`);
            updateUI(true, gasValue, isAlarm);
        }

        function onDisconnected(event) {
            log('Device disconnected. Re-enabling connect button.');
            updateUI(false);
            gasCharacteristic = null;
            bleDevice = null;
        }

        // --- Main Connection Logic ---
        async function connectBLE() {
            // If already connected, disconnect
            if (bleDevice && bleDevice.gatt.connected) {
                bleDevice.gatt.disconnect();
                return; // Disconnect handled by onDisconnected listener
            }

            log('Attempting to connect to BLE device...');
            updateUI(false, 'Scanning...');

            try {
                // 1. Request the device
                // Added acceptAllDevices: true as a fallback, but filter by name first is best practice
                bleDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ name: DEVICE_NAME }], 
                    optionalServices: [SERVICE_UUID]
                });

                log(`Found device: ${bleDevice.name}. Connecting...`);
                bleDevice.addEventListener('gattserverdisconnected', onDisconnected);

                // 2. Connect to the GATT server
                const server = await bleDevice.gatt.connect();
                log('Connected to GATT Server.');

                // 3. Get the Service
                const service = await server.getPrimaryService(SERVICE_UUID);
                log('Found Gas Sensor Service.');

                // 4. Get the Characteristic
                gasCharacteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);
                log('Found Gas Value Characteristic.');

                // 5. Start notifications (Subscribes to updates from ESP32)
                await gasCharacteristic.startNotifications();
                gasCharacteristic.addEventListener('characteristicvaluechanged', handleGasValueChange);
                log('Notifications started. Receiving real-time data.');

                // Initial UI update
                updateUI(true, 'WAITING...', false);

            } catch (error) {
                // Check if error is due to user cancellation or general connection failure
                const errorMessage = error.message.includes('User cancelled') ? 'Connection cancelled by user.' : `Connection Error: ${error.message}`;
                log(errorMessage, true);
                updateUI(false);
                gasCharacteristic = null;
                bleDevice = null;
            }
        }

        // --- Initialize ---
        window.onload = () => {
            if (!navigator.bluetooth) {
                log("Web Bluetooth API is not supported by your browser. Use Chrome, Edge, or Brave over HTTPS.", true);
                connectButton.disabled = true;
                connectButton.textContent = 'BLE Not Supported';
                return;
            }
            connectButton.addEventListener('click', connectBLE);
            log("Click 'Connect' to start monitoring.");
        };
    </script>

</body>
</html>
